<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ORACLE之存储过程和函数 | Yhchdev</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ORACLE之存储过程和函数</h1><a id="logo" href="/.">Yhchdev</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/jinengshu/"><i class="fa fa-tree"> 技能</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ORACLE之存储过程和函数</h1><div class="post-meta">Apr 30, 2018</div><div class="post-content"><h4 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h4><h5 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h5><p>存储过程（Stored Procedure）是在大型数据库系统中，一组为了完成特定功能的SQL 语句集，存储在数据库中，经过第一次编译后再次调用不需要再次编译，用户通过指定存储过程的名字并给出参数（如果该存储过程带有参数）来执行它。存储过程是数据库中的一个重要对象。</p>
<h5 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h5><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="function"><span class="keyword">procedure</span></span></span><br><span class="line"><span class="function">  &lt;过程名&gt;[参数名 参数模式<span class="params">(<span class="keyword">in</span>/<span class="keyword">out</span>/int <span class="keyword">out</span>)</span> 数据类型:</span>=value]</span><br><span class="line"> <span class="keyword">begin</span></span><br><span class="line">   PL/SQL语句;</span><br><span class="line"> <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<h5 id="参数模式"><a href="#参数模式" class="headerlink" title="参数模式"></a>参数模式</h5><ul>
<li>In 参数</li>
</ul>
<p>输入参数，调用时存储过程待接收的参数<br>可以是常数，数据量，初始化变量或表达式</p>
<p>创建带in参数存储过程</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="function"><span class="keyword">procedure</span></span></span><br><span class="line"><span class="function">  <span class="title">pro_InsertClassInfo</span><span class="params">(strClassID varchar2,strClassName Varchar2)</span></span></span><br><span class="line"><span class="function"><span class="title">is</span></span></span><br><span class="line"><span class="function"><span class="title">begin</span></span></span><br><span class="line"><span class="function">  <span class="title">insert</span> <span class="title">into</span> <span class="title">classinfo</span><span class="params">(classid,classname)</span></span></span><br><span class="line"><span class="function">  <span class="title">values</span><span class="params">(strClassID,strClassName)</span>;</span></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>调用存储过程<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">exec pro_insertclassinfo('<span class="number">20161152</span>0','计算机科学与技术');</span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>   </p>
<p><img src="/2018/04/30/ORACLE之存储过程和函数/pictwo.png" alt="pictone"></p>
<p>创建存储过程，若记录存在则更新，不存在则添加记录</p>
<figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">create <span class="keyword">or</span> replace <span class="function"><span class="keyword">procedure</span></span></span><br><span class="line"><span class="function">  <span class="title">pro_merageclassinfo</span><span class="params">(strid varchar2,strname varchar2)</span></span></span><br><span class="line"><span class="function"><span class="title">is</span></span></span><br><span class="line"><span class="function">  <span class="title">recount</span> <span class="title">int</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  select count(*) into recount from classinfo where classid=strid;</span><br><span class="line">  <span class="keyword">if</span> recount&gt;<span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    update classinfo set classname=strname where classid=strid;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    insert into classinfo(classid,classname) values (strid,strname);</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exec pro_merageclassinfo(<span class="string">'201611520'</span>,<span class="string">'大数据与智能工程'</span>);</span><br><span class="line">// classid已存在执行更新操作</span><br><span class="line">exec pro_merageclassinfo(<span class="string">'201811520'</span>,<span class="string">'区块链技术'</span>);</span><br><span class="line">//新纪录执行插入操作</span><br><span class="line"></span><br><span class="line"> </span><br></pre></td></tr></table></figure>   
<ul>
<li>Out 参数</li>
</ul>
<p>输出参数，存储过程运行后的结果赋值给输出参数，显示到屏幕<br>参数只能是变量，不能是常数或表达式</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="function"><span class="keyword">procedure</span></span></span><br><span class="line"><span class="function">  <span class="title">pro_getavgscore</span><span class="params">(strno varchar2,avgscore <span class="keyword">out</span> number)</span></span></span><br><span class="line"><span class="function"><span class="title">is</span></span></span><br><span class="line"><span class="function"><span class="title">begin</span></span></span><br><span class="line"><span class="function">  <span class="title">select</span> <span class="title">avg</span><span class="params">(studscore)</span> <span class="title">into</span> <span class="title">avgscore</span> <span class="title">from</span> <span class="title">studscoreinfo</span></span></span><br><span class="line"><span class="function">  <span class="title">where</span> <span class="title">studno</span>=<span class="title">strno</span>;</span></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>    
<p>调用存储过程<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">  avgscore <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  pro_getavgscore(<span class="string">'20010704035'</span>,avgscore);</span><br><span class="line">  dbms_output.put_line(avgscore);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>    </p>
<p><img src="/2018/04/30/ORACLE之存储过程和函数/picone.png" alt="pictwo"><br>示列</p>
<ul>
<li>In Out 参数</li>
</ul>
<p>输入和输出，接受值并返回已更新的值<br>参数只能是变量，不能是常数或表达式</p>
<p>创建存储过程<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="function"><span class="keyword">procedure</span> </span></span><br><span class="line"><span class="function">  <span class="title">Pro_getstudscore</span><span class="params">(strno varchar2,avgscore <span class="keyword">in</span> <span class="keyword">out</span> number)</span></span></span><br><span class="line"><span class="function"><span class="title">is</span></span></span><br><span class="line"><span class="function"><span class="title">begin</span></span></span><br><span class="line"><span class="function">  <span class="title">dbms_output</span>.<span class="title">put_line</span><span class="params">(avgscore+5)</span>;</span></span><br><span class="line">  <span class="keyword">select</span> avg(studscore) <span class="keyword">into</span> avgscore </span><br><span class="line">  <span class="keyword">from</span> studscoreinfo</span><br><span class="line">  <span class="keyword">where</span> studno=strno;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><br>调用存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">  avgscore <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Pro_getstudscore(<span class="string">'20010505001'</span>,avgscore);</span><br><span class="line">  dbms_output.put_line(avgscore);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><h5 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span></span><br><span class="line">  &lt;函数名&gt;[参数<span class="number">1</span>，参数<span class="number">2.</span>..参数n]</span><br><span class="line"><span class="keyword">return</span> 返回值的数类型 </span><br><span class="line"><span class="keyword">is</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  PL/<span class="keyword">SQL</span>语句;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>    
<p>参数说明<br>(变量名1 数据类型1:=value1,变量名2 数据类型2:=value2)</p>
<h5 id="函数实例"><a href="#函数实例" class="headerlink" title="函数实例"></a>函数实例</h5><p>  学生成绩统分函数，规则：多选或错选或不选给0分,少选给选对的分</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> </span><br><span class="line">  getitemscore(Stand_ans <span class="built_in">varchar</span> ,custor_ans varchar2)//参数是数据表中的标准答案和学生的答案</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">int</span>  //函数的返回值是<span class="built_in">int</span>类型</span><br><span class="line"><span class="keyword">is</span></span><br><span class="line">  Lencustor <span class="built_in">int</span>:=<span class="keyword">length</span>(custor_ans);//获取学生答案的长度</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> Lencustor&gt;<span class="keyword">length</span>(Stand_ans) <span class="keyword">or</span> Custor_ans <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;//多选或没选返回0分</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">    for i in 1..Lencustor</span><br><span class="line">    loop</span><br><span class="line">      if instr(Stand_ans,substr(custor_ans,i,1)) = 0 then</span><br><span class="line">        return 0;//如果学生答案中有记录没在标准答案中，即有错选答案</span><br><span class="line">      <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">    return Lencustor; //没有错选，给选对的分，分数就是答案的长度</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>测试这个统分函数</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">getitemscore</span>(<span class="params"><span class="string">'ABC'</span>,<span class="string">'AC'</span></span>) <span class="keyword">from</span> dual</span>;</span><br><span class="line"><span class="comment">//少选的情况</span></span><br><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">getitemscore</span>(<span class="params"><span class="string">'AC'</span>,<span class="string">'ABC'</span></span>) <span class="keyword">from</span> dual</span>;</span><br><span class="line"><span class="comment">//多选的情况</span></span><br><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">getitemscore</span>(<span class="params"><span class="string">'ABC'</span>,<span class="string">'ACD'</span></span>) <span class="keyword">from</span> dual</span>;</span><br><span class="line"><span class="comment">//错选的情况</span></span><br></pre></td></tr></table></figure>    
<p><img src="/2018/04/30/ORACLE之存储过程和函数/picthree.png" alt="picthree"></p>
<p> 统计600个学生共60000条记录的分数</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">select studno,</span><br><span class="line">sum(getitemscore(stand_anx,custor_anx))<span class="number">*100</span>/</span><br><span class="line">sum(Length(stand_anx)) as studscore</span><br><span class="line"><span class="keyword">from</span> answer</span><br><span class="line">group by studno</span><br></pre></td></tr></table></figure> 
<p> <img src="/2018/04/30/ORACLE之存储过程和函数/picfour.png" alt="picfour"><br>ps:六万条数据统分，set timing on,所花时间是1.46s,oracle是真的牛逼</p>
<h4 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h4><ol>
<li>编写一个函数，实现求N!（即N 的阶乘），测试5!（即5 的阶乘）。</li>
</ol>
<p>A.创建函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">function</span> getjc(n <span class="built_in">int</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">number</span> </span><br><span class="line"> <span class="keyword">is</span></span><br><span class="line">  k <span class="built_in">number</span>:=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span>.n</span><br><span class="line">  <span class="keyword">loop</span></span><br><span class="line">    k:=k*i;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">  return k;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>    
<p>B.调用函数<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">getjc</span>(<span class="params"><span class="number">5</span></span>) <span class="keyword">from</span> dual</span>;</span><br></pre></td></tr></table></figure>    </p>
<ol start="2">
<li>创建一个简单的存储过程，求S=1!+2!+3!+4!+…+N!，直到S 大于10000 时N 的值和S的值。(注：阶乘可以写一个函数完成)</li>
</ol>
<p>A.创建存储过程<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="function"><span class="keyword">procedure</span></span></span><br><span class="line"><span class="function">  <span class="title">proce_getsumjc</span><span class="params">(k <span class="keyword">out</span> number,s <span class="keyword">out</span> number)</span></span></span><br><span class="line"><span class="function"><span class="title">is</span></span></span><br><span class="line"><span class="function">  <span class="title">i</span> <span class="title">number</span>:</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  s:=<span class="number">0</span>;</span><br><span class="line">  k:=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">loop</span></span><br><span class="line">  k:=K*i;</span><br><span class="line">  i:=i+<span class="number">1</span>;</span><br><span class="line">  s:=s+k;</span><br><span class="line">  <span class="keyword">if</span> s &gt; <span class="number">10000</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">  dbms_output.put_line(<span class="string">'s='</span>||s);</span><br><span class="line">  dbms_output.put_line(<span class="string">'n='</span>||k);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure></p>
<p>B.调用存储过程<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">  K <span class="built_in">number</span>;</span><br><span class="line">  s number;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  proce_getsumjc(k,s);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure></p>
<ol start="3">
<li>创建一个带输入参数的存储过程，输入分数参数，执行存储过程得到平均分大于该分数的学生统计成绩信息（包括学号，姓名，平均分，课程门数字段）。</li>
</ol>
<p>A.创建存储过程<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">procedure</span> procedure_avg(inputscore <span class="built_in">number</span>) </span><br><span class="line"><span class="keyword">is</span></span><br><span class="line">  sstudno studinfo.studno%<span class="keyword">Type</span>;</span><br><span class="line">  sstudname studinfo.studname%Type;</span><br><span class="line">  savgscore studscoreinfo.studscore%Type;</span><br><span class="line">  coursecount number;</span><br><span class="line">cursor mycur is </span><br><span class="line">  <span class="keyword">select</span> s.studno,studname,<span class="keyword">avg</span>(studscore),<span class="keyword">count</span>(*) <span class="keyword">count</span></span><br><span class="line">  <span class="keyword">from</span> studinfo s,studscoreinfo ss</span><br><span class="line">  <span class="keyword">where</span> s.studno=ss.studno</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> s.studno,studname</span><br><span class="line">  <span class="keyword">having</span> <span class="keyword">avg</span>(studscore)&gt; inputscore;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">open</span> mycur;</span><br><span class="line">  fetch mycur into sstudno,sstudname,savgscore,coursecount;</span><br><span class="line">  while mycur%found</span><br><span class="line">  loop</span><br><span class="line">    dbms_output.put_line(sstudno||sstudname||savgscore||coursecount);</span><br><span class="line">    fetch mycur into sstudno,sstudname,savgscore,coursecount;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">close mycur;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">//这里会查询出多条记录，oracle并不能操作一个结果集，只能通过游标取出每条记录，我将下一篇博客学习游标</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>B.调用存储过程</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec procedure_avg(<span class="number">80</span>)<span class="comment">; </span></span><br></pre></td></tr></table></figure>    
<ol start="4">
<li>创建带两个输入参数和一个输出参数的存储过程，执行存储过程时，输入参数为分数段，输出参数为得到该分数段的人数。</li>
</ol>
<p>A.创建存储过程<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">procedure</span> </span><br><span class="line">  procedure_count(minscore <span class="keyword">in</span> <span class="built_in">number</span>,maxscore <span class="keyword">in</span> <span class="built_in">number</span>,countp <span class="keyword">out</span> <span class="built_in">number</span>) </span><br><span class="line"><span class="keyword">is</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">into</span> countp</span><br><span class="line">  <span class="keyword">from</span></span><br><span class="line">  (</span><br><span class="line">  <span class="keyword">select</span> studno</span><br><span class="line">  <span class="keyword">from</span> studscoreinfo</span><br><span class="line">  <span class="keyword">group</span> <span class="keyword">by</span> studno</span><br><span class="line">  <span class="keyword">having</span> <span class="keyword">avg</span>(studscore) <span class="keyword">between</span> minscore <span class="keyword">and</span> maxscore</span><br><span class="line"> );</span><br><span class="line">  dbms_output.put_line(countp);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure></p>
<p>B.调用存储过程<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">  countp <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  procedure_count(<span class="number">60</span>,<span class="number">70</span>,countp); </span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>    </p>
<ol start="5">
<li>创建一个学生成绩统计函数（GetEveryItemScore），多选记 0 分，少选记选对分。</li>
</ol>
<p>A.创建函数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Create</span> <span class="keyword">Or</span> <span class="keyword">Replace</span> <span class="keyword">Function</span> GetItemScore(Stand_Ans</span><br><span class="line">varchar2,Custor_Ans varchar2)</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">int</span> <span class="keyword">is</span></span><br><span class="line">LenCustor <span class="built_in">int</span>:=<span class="keyword">length</span>(Custor_Ans);</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> LenCustor&gt;<span class="keyword">length</span>(stand_ans) <span class="keyword">or</span> Custor_Ans <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;//多选或没选返回0分</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">for i in 1..LenCustor</span><br><span class="line">loop</span><br><span class="line">  if instr(stand_ans,substr(custor_ans,i,1))=0 then</span><br><span class="line">  return 0;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span>;//如果学生答案中有记录没在标准答案中，即有错选答案</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line">  return LenCustor;//返回答案的长度即得分</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><br>B.调用函数<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">getitemscore</span>(<span class="params"><span class="string">'ABC'</span>,<span class="string">'BC'</span></span>) <span class="keyword">from</span> dual</span>;</span><br></pre></td></tr></table></figure>        </p>
<ol start="6">
<li>将当前文件夹下电子表格(StudScore.xls)所有数据导入到自己的数据库中，利用题目 5 中创建的函数统计各学生成绩。</li>
</ol>
<p>A.创建表</p>
<p>答案表<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table Answer</span><br><span class="line">(</span><br><span class="line">stand_anx varchar2(<span class="number">15</span>),</span><br><span class="line">custor_anx varchar2(<span class="number">15</span>),</span><br><span class="line">studno varchar2(<span class="number">20</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><br>成绩表<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table studscore</span><br><span class="line">(</span><br><span class="line">studno varchar2(<span class="number">15</span>) primary key,</span><br><span class="line">studname varchar2(<span class="number">15</span>),</span><br><span class="line">studscore number(<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>    </p>
<p>B.导入数据<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">infile</span> <span class="string">'c:\csv'</span></span><br><span class="line">append <span class="keyword">into</span> <span class="keyword">table</span> answer</span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span></span><br><span class="line">(stand_anx,custor_anx,studno)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">infile</span> <span class="string">'c:\StudScore.csv'</span></span><br><span class="line">append <span class="keyword">into</span> <span class="keyword">table</span> studscore</span><br><span class="line"><span class="keyword">fields</span> termiated <span class="keyword">by</span> <span class="string">','</span></span><br><span class="line">(studno,studname,studscore)</span><br></pre></td></tr></table></figure><br>C.计算得分<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select studno,</span><br><span class="line">sum(getitemscore(stand_anx,custor_anx))<span class="number">*100</span>/</span><br><span class="line">sum(Length(stand_anx)) as studscore</span><br><span class="line"><span class="keyword">from</span> answer</span><br><span class="line">group by studno</span><br></pre></td></tr></table></figure>    </p>
<ol start="7">
<li>利 用 6 题 查 询 结 果 ， 创 建 一 个 学 生 成 绩 统 计 视 图 （ ViewGetStudScore ）， 包 括StudNo,StudScore 字段。并写出将视图中的成绩更新到表 StudScore 中的 SQL 语句。</li>
</ol>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line"><span class="keyword">merge</span> <span class="keyword">into</span> studscore</span><br><span class="line"><span class="keyword">using</span> v_getstudcore</span><br><span class="line"><span class="keyword">on</span>(v_getstudcore.studno=studscore.studno)</span><br><span class="line"><span class="keyword">when</span> <span class="keyword">matched</span> <span class="keyword">then</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">set</span> studscore.studscore=v_getstudcore.studscore</span><br></pre></td></tr></table></figure>    
<ol start="8">
<li>利用 7题的结果，将表StudScore中的前20名（以分数高低排）导入新表(Top20StudScore)，包括学号、姓名、成绩字段。</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> top20studscore</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> studscore</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span></span><br><span class="line">)A</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">rownum</span>&lt;=<span class="number">20</span></span><br></pre></td></tr></table></figure>
</div><iframe src="/donate/?AliPayQR=/img/AliPayQR.jpg&amp;WeChatQR=/img/WeChatQR.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/05/01/ORACLE之触发器和游标/">ORACLE之触发器和游标</a><a class="next" href="/2018/04/27/ORACLE之ProcedureLanguage/">ORACLE之ProcedureLanguage</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zNTcwNS8xMjI0MQ=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yoursite.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/19/Ubuntu-配置仿MacOS主题/">[Ubuntu]配置仿MacOS主题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/07/Python3爬虫-selenium爬取淘宝商品信息/">[Python3爬虫]selenium爬取淘宝商品信息</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/03/JSP-搭建开发环境/">[JSP]搭建开发环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/28/随笔-倚天屠龙记读后感/">[随笔]倚天屠龙记读后感</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/19/Design-Pattern-单例模式/">[Design Pattern]单例模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/17/Design-Pattern-抽象工厂模式/">[Design Pattern]抽象工厂模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/10/DesignPattern-FactoryPattern/">[DesignPattern]FactoryPattern</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/08/Python3爬虫-selenium-chromedriver可见即可爬/">[Python3爬虫]selenium+chromedriver可见即可爬</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/02/Python3-Ajax请求信息的爬取/">[Python3]Ajax请求信息的爬取</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/18/Python3爬虫-Beautiful-Soup解析库/">[Python3爬虫]Beautiful Soup解析库</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Yhchdev.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async="async"></script><span id="busuanzi_container_site_pv">|访问量<span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv">|访客数<span id="busuanzi_value_site_uv"> </span></span></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>